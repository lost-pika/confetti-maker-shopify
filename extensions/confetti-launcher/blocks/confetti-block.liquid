<div
  id="confetti-launcher-root"
  data-confetti-config="{{ shop.metafields.confetti_maker.active_config.value }}"
  data-trigger-event="{{ shop.metafields.confetti_maker.trigger_event.value }}"
></div>

<!-- Load confetti library -->
<script
  src="{{ 'confetti.browser.min.js' | asset_url }}"
  defer
></script>

<script>
(function () {
  console.log("ðŸ”¥ CONFETTI BLOCK LOADED");

  function onReady(cb) {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", cb);
    } else {
      cb();
    }
  }

  function waitForConfetti(cb) {
    if (window.confetti) {
      cb();
    } else {
      setTimeout(function () {
        waitForConfetti(cb);
      }, 50);
    }
  }

  onReady(function () {
    waitForConfetti(function () {
      console.log("[Confetti] confetti lib ready");

      var root = document.getElementById("confetti-launcher-root");
      if (!root) {
        console.log("[Confetti] root not found");
        return;
      }

      var rawConfig = root.getAttribute("data-confetti-config");
      var triggerEvent = root.getAttribute("data-trigger-event") || "page_load";

      console.log("[Confetti] rawConfig:", rawConfig);
      console.log("[Confetti] triggerEvent:", triggerEvent);

      if (!rawConfig || rawConfig === "{}") {
        console.log("[Confetti] empty config, aborting");
        return;
      }

      var config;
      try {
        config = JSON.parse(rawConfig);
      } catch (e) {
        console.error("[Confetti] JSON parse error", e);
        return;
      }

      function shouldTrigger() {
        switch (triggerEvent) {
          case "page_load":
            return true;
          case "purchase_complete":
            return window.location.pathname.includes("/thank_you");
          case "new_year":
            var d = new Date();
            return d.getMonth() === 0 && d.getDate() === 1;
          default:
            return false;
        }
      }

      if (!shouldTrigger()) {
        console.log("[Confetti] trigger condition not met");
        return;
      }

      console.log("[Confetti] firing ðŸŽ‰");

      var base = {
        particleCount: config.particleCount || 150,
        spread: config.spread || 70,
        gravity: config.gravity ?? 1,
        origin: config.origin || { x: 0.5, y: 0.6 },
        colors: config.colors,
        shapes: config.shapes
      };

      switch (config.burstType) {
        case "cannon":
          window.confetti({
            ...base,
            angle: 60,
            startVelocity: 60,
            ticks: 150
          });
          break;

        case "fireworks":
          for (var i = 0; i < 3; i++) {
            window.confetti({
              ...base,
              particleCount: Math.round(base.particleCount / 3),
              startVelocity: 50,
              spread: 80,
              ticks: 250,
              gravity: 0.9,
              origin: {
                x: 0.2 + 0.3 * i,
                y: Math.random() * 0.4 + 0.1
              }
            });
          }
          break;

        case "pride":
          window.confetti({
            ...base,
            spread: 120,
            startVelocity: 35,
            scalar: 1.2,
            ticks: 300,
            gravity: 0.7
          });
          break;

        case "snow":
          window.confetti({
            ...base,
            particleCount: 250,
            spread: 160,
            gravity: 0.3,
            startVelocity: 10,
            scalar: 0.8,
            ticks: 400,
            drift: 0.6
          });
          break;

        default:
          window.confetti({
            ...base,
            startVelocity: 45
          });
      }
    });
  });
})();
</script>

{% schema %}
{
  "name": "Confetti Launcher",
  "target": "section",
  "settings": []
}
{% endschema %}
